# Руководство по миграции: с Supabase на n8n-Postgres

Это руководство описывает процесс переноса ваших существующих данных n8n (воркфлоу, креды, история выполнений) из старой конфигурации (где n8n использовал Postgres от Supabase) на новую (где n8n имеет свой собственный контейнер `n8n-db`).

## Предварительные требования

- Доступ к терминалу сервера.
- Доступность как старого контейнера Supabase (`supabase-db`), так и новой структуры проекта.
- Наличие скрипта `start-stack.sh`.

## Шаг 1: Резервное копирование старых данных

Сначала необходимо извлечь данные из базы данных Supabase.

1.  **Убедитесь, что Supabase DB работает**:
    Если она не запущена, запустите её:
    ```bash
    cd supabase
    docker compose up -d db
    ```

2.  **Экспорт схемы `n8n`**:
    Мы создадим дамп только схемы `n8n`, которая содержит все данные n8n.
    ```bash
    mkdir -p backups/migration
    docker exec supabase-db pg_dump -U postgres -n n8n postgres > backups/migration/n8n-schema-dump.sql
    ```

3.  **Сохраните ключ шифрования n8n**:
    **ВАЖНО**: Вы должны использовать тот же самый `N8N_ENCRYPTION_KEY` из вашего старого файла `.env` в новом файле `n8n/.env`. Если вы измените этот ключ, n8n не сможет расшифровать ваши учетные данные (credentials), и вам придется вводить их заново.
    *   Проверьте старый `.env`: `cat n8n/.env` (ищите `N8N_ENCRYPTION_KEY`).
    *   Проверьте новый `.env`: Убедитесь, что в `n8n/.env` тот же ключ.

4.  **Резервное копирование файлов n8n (Опционально)**:
    Если у вас были бинарные файлы или локальные файлы, сохраненные в директории `.n8n` или томе `files`, их стоит сохранить, используя скрипт `backup-stack.sh` или вручную.

    ```bash
    ./scripts/backup/backup-stack.sh
    # Выберите 'n8n' чтобы сделать бэкап тома
    ```

## Шаг 2: Подготовка нового окружения

1.  **Остановите всё**:
    ```bash
    docker stop $(docker ps -aq)
    ```

2.  **Проверьте новую конфигурацию**:
    Убедитесь, что `n8n/docker-compose.yml` использует сервис `n8n-db`.
    Убедитесь, что `n8n/.env` настроен правильно (хост БД `n8n-db`, пользователь `n8n` и т.д.).

## Шаг 3: Импорт данных в новую базу

1.  **Запустите новый стек n8n**:
    ```bash
    ./start-stack.sh
    # Выберите 'n8n' (и при желании NPM/Cloudflared)
    ```
    Это запустит `n8n` и `n8n-db`. Сначала `n8n` может упасть или запуститься пустым, так как `n8n-db` новая и чистая.

2.  **Дождитесь готовности `n8n-db`**:
    Проверьте статус:
    ```bash
    docker ps
    # Ждите, пока статус n8n-db не станет (healthy)
    ```

3.  **Импорт дампа**:
    Нужно импортировать SQL дамп в новую `n8n-db`.
    
    Дамп из Supabase (`pg_dump -n n8n`) содержит команды вроде `CREATE SCHEMA n8n;` и `CREATE TABLE n8n.user ...`.
    
    Давайте импортируем его как есть:
    ```bash
    cat backups/migration/n8n-schema-dump.sql | docker exec -i n8n-db psql -U postgres_user -d n8n
    ```
    
    *Примечание: Мы используем суперпользователя `postgres_user`, чтобы гарантированно иметь права на создание схем.*

4.  **Настройте n8n на использование схемы `n8n`**:
    Откройте `n8n/.env` и убедитесь, что указано:
    ```bash
    DB_POSTGRESDB_SCHEMA=n8n
    ```
    (Если там будет `public`, n8n не увидит импортированные данные и будет думать, что база пуста).

## Шаг 4: Проверка

1.  **Перезапустите n8n**:
    ```bash
    cd n8n
    docker compose restart
    ```

2.  **Проверьте логи**:
    ```bash
    docker logs n8n -f
    ```
    Ищите сообщения "Migrations". Скрипт должен сообщить, что нашел существующие данные.

3.  **Вход**:
    Зайдите на ваш URL n8n. Ваши старые логин и пароль должны работать. ВСЕ ваши воркфлоу должны быть на месте.

## Возможные проблемы

-   **"Relation does not exist"**: Скорее всего, вы импортировали данные в схему `n8n`, но конфиг n8n настроен на `public` (или наоборот). Проверьте `DB_POSTGRESDB_SCHEMA` в `.env`.
-   **"Decrypt failed" (Ошибка расшифровки)**: Ваш `N8N_ENCRYPTION_KEY` не совпадает с тем, который использовался при шифровании данных в старой базе. Восстановление паролей невозможно без оригинального ключа.
